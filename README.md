# agent-test

AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å‹•ä½œç†è§£ç”¨ã®ãƒ†ã‚¹ãƒˆå®Ÿè£…ã§ã™ã€‚

## simple-weather

MCPã‚’ä½¿ã‚ãšã«LangChainã‹ã‚‰OpenAIã®APIã‚’å®Ÿè¡Œã—ã¦å¤©æ°—äºˆå ±ã—ã¾ã™ã€‚

## mcp-weather

MCPã‚’ä½¿ã£ã¦LangGraphã‹ã‚‰OpenAIã®APIã‚’å®Ÿè¡Œã—ã¦å¤©æ°—äºˆå ±ã—ã¾ã™ã€‚  
MCPã‚µãƒ¼ãƒã¨ã—ã¦å¤©æ°—æƒ…å ±ã‚’å–å¾—ã™ã‚‹Weatherã¨ãƒ€ãƒŸãƒ¼ã®RoomStatusNowã‚’ä½œæˆã—ã¦ã„ã¾ã™ã€‚  
è³¢ã„ãƒ¢ãƒ‡ãƒ«ã ã¨Weatherã®ã¿å‘¼ã³å‡ºã—ã¾ã™ãŒã€ãã†ã§ãªã„ãƒ¢ãƒ‡ãƒ«ã¯ä¸¡æ–¹å‘¼ã³å‡ºã™ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚

## file-edit

FileIOç”¨ã®MCPã‚µãƒ¼ãƒã‚’å®šç¾©ã—ã¦AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒãƒ•ã‚¡ã‚¤ãƒ«æ“ä½œã—ã¾ã™ã€‚  
make runã§ã¯Dockerä¸Šã®/tmpã§æ“ä½œã•ã‚Œã€å®Ÿè¡Œçµ‚äº†å¾Œãƒ•ã‚¡ã‚¤ãƒ«ã¯ãªããªã‚Šã¾ã™ã€‚  
make localã™ã‚‹ã¨mount/ä»¥ä¸‹ã«ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚  

## mcp-exec

file-editã«ã•ã‚‰ã«AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä½œæˆã—ãŸPythonãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®Ÿè¡Œã§ãã‚‹æ©Ÿèƒ½ã‚’ä»˜åŠ ã—ã¾ã—ãŸã€‚  
AIãŒè¨ˆç®—ã—ã¦ç­”ãˆã‚’å°ãã“ã¨ãŒå¯èƒ½ã§ã™ã€‚  
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¼·ã„å®Ÿè¡Œæ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã®ã§æ‰±ã„ã¯æ°—ã‚’ä»˜ã‘ã¦ãã ã•ã„ã€‚  
Dockerä¸Šã®érootãƒ¦ãƒ¼ã‚¶ã§å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ã§AIã®å®Ÿè¡Œå½±éŸ¿ã‚’åˆ¶é™ã—ã¦ã„ã¾ã™ã€‚ 
ãŸã ã—ã€ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«å†…ã§subprocessã‚’ä½¿ã†ã“ã¨ã§OSã‚³ãƒãƒ³ãƒ‰å®Ÿè¡ŒãŒå¯èƒ½ã«ãªã£ã¦ã„ã¾ã™ã€‚   
å¯¾è©±ã§ããªã„ã®ã§æœ€åˆã«ä¸€å›æŒ‡ç¤ºã‚’ä¸ãˆã‚‹ã“ã¨ã—ã‹ã§ãã¾ã›ã‚“ã€‚  

## diag-agent-exec

mcp-execã‚’æ©Ÿèƒ½å¼·åŒ–ã—ã€å¯¾è©±å½¢å¼ã§ãƒ¦ãƒ¼ã‚¶ãŒæŒ‡ç¤ºã‚’å‡ºã›ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚  
mcp-execåŒæ§˜ã«AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒå¼·ã„æ¨©é™ã‚’æŒã¤ã®ã§æ³¨æ„ã—ã¦ãã ã•ã„ã€‚  
Pythonã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒãªã„å ´åˆã¯sys.executable -m pip install ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åã‚’å®Ÿè¡Œã•ã›ã‚‹ã“ã¨ã§Dockerå†…ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã›ã‚‰ã‚Œã¾ã™ã€‚ã€‚  
å¯¾è©±ã§ã¯éå»ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¨ã¦ä¿æŒã™ã‚‹ã®ã§ã€ã‚„ã‚Šå–ã‚ŠãŒé•·ããªã‚‹ã»ã©èª²é‡‘é¡ãŒå¤§ãããªã‚Šã¾ã™ã€‚  
pytestã¨flake8ã®requirements.txtã«è¿½åŠ ã—ã¾ã—ãŸã€‚å®Ÿè¡Œæ™‚ã«ã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã‹ã‚‰pytest.main()ã‚’å®Ÿè¡Œã•ã›ã‚‹ãªã©ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  

## æ³¨æ„äº‹é …

å¤©æ°—äºˆå ±ã«ã¯å¤©æ°—äºˆå ±APIã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚  
ã‚³ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œã™ã‚‹å ´åˆã¯äº‹å‰ã«ä½¿ç”¨æ¡ä»¶ç­‰ã‚’ã”ç¢ºèªãã ã•ã„ã€‚  
https://weather.tsukumijima.net/

OpenAIã®APIã¯åˆ©ç”¨è€…ãŒAPIã‚­ãƒ¼ã‚’å–å¾—ã—ã€.envãƒ•ã‚¡ã‚¤ãƒ«ã«è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚  
`OPENAI_API_KEY=APIã‚­ãƒ¼ã®å€¤`  

APIã®æ–™é‡‘ã¯åˆ©ç”¨è€…ãŒæ”¯æ‰•ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚


## å®Ÿè¡Œæ–¹æ³•

makeã¨dockerãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚ã‚‹ã“ã¨ãŒå‰æã¨ãªã‚Šã¾ã™ã€‚  

å„ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«å…¥ã£ã¦dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’buildã—ã¾ã™ã€‚
`make build`

æ¬¡ã«dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’èµ·å‹•ã—ã¦Pythonã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
`make run`ã¾ãŸã¯`make local`  
runã§ã¯ä½œæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã¯å®Ÿè¡Œçµ‚äº†æ™‚ã«å‰Šé™¤ã•ã‚Œã¾ã™ã€‚  
localã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ã®mountãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”Ÿæˆã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒæ®‹ã‚Šã¾ã™ã€‚  

å®Ÿè¡Œçµæœã‚µãƒ³ãƒ—ãƒ«ã‚’logsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã„ãã¤ã‹æ ¼ç´ã—ã¾ã—ãŸã€‚


## ã‚³ãƒ¼ãƒ‰ã®èª¬æ˜

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå¾Œç¶š
mcp-weatherã®å ´åˆã€ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã¨ãªã‚‹ã€‚

```
diag-agent-exec/  
 â”œâ”€â”€ Makefile  
 â”œâ”€â”€ Dockerfile  
 â”œâ”€â”€ requirements.txt  
 â””â”€â”€ app/  
     â”œâ”€â”€ mcp_test.py  
     â”œâ”€â”€ room_mcp.py  
     â”œâ”€â”€ weather.py  
     â””â”€â”€ weather_mcp.py  
```

Makefileã¯dockerã‚³ãƒãƒ³ãƒ‰ã‚’ãƒ©ãƒƒãƒ‘ãƒ¼ã—ã¦å®Ÿè¡Œã—ã‚„ã™ãã™ã‚‹makeã®å®šç¾©ã‚’è¨˜è¼‰ã—ã¦ã„ã‚‹ã€‚  
Dockerfileã¯appä»¥ä¸‹ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã™ã‚‹dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’è¨˜è¼‰ã—ã¦ã„ã‚‹ã€‚  
requirements.txtã¯dockerã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹pythonãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¨˜è¼‰ã—ã¦ã„ã‚‹ã€‚  
appä»¥ä¸‹ã¯å®Ÿè¡Œã•ã‚Œã‚‹Pythonãƒ•ã‚¡ã‚¤ãƒ«ã¨ã€MCPã‚’å®šç¾©ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’é…ç½®ã—ã¦ã„ã‚‹ã€‚  

### ã‚³ãƒ¼ãƒ‰ã®å†…å®¹

MCPã‚µãƒ¼ãƒã‚’å®šç¾©ã—ã¦ã„ã‚‹weather\_mcp.pyã«ã¤ã„ã¦ä¸­èº«ã‚’è¦‹ã¦ã¿ã‚‹ã€‚
```
from mcp.server.fastmcp import FastMCP
import weather
import sys
import io

sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')

mcp = FastMCP("Weather")

@mcp.tool()
def get_weather(weather_code: str) -> dict:
    """ å¤©æ°—äºˆå ±APIã‹ã‚‰wather_codeã®å¤©æ°—ã‚’å–å¾—ã™ã‚‹ã€‚æ±äº¬ã®å ´åˆã¯130010 """
    return weather.get(weather_code)


if __name__ == "__main__":
    mcp.run(transport="stdio")
```
å†…å®¹ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§ã€
` mcp = FastMCP("Weather")`ã«MCPã®åå‰ã¤ã‘ã‚‹ã®ã¨ã€
MCPã¨ã—ã¦æä¾›ã—ãŸã„é–¢æ•°ã«`@mcp.tool()`ã‚’ã¤ã‘ã¦ã„ãã®ãŒä¿®æ­£ç®‡æ‰€ã§ç°¡å˜ã«MCPã§æ©Ÿèƒ½ã‚’AIã«æä¾›ã§ãã‚‹ã€‚


æ¬¡ã«ãƒ¡ã‚¤ãƒ³å‡¦ç†ã§ã‚ã‚‹mcp\_test.pyã‚’è¦‹ã¦ã¿ã‚‹ã€‚
```
# OpenAI APIã‚­ãƒ¼ã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®šã—ã¦ãŠã
# .envã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€OPENAI_API_KEY=<API KEY>ã‚’è¨˜è¼‰ã™ã‚‹
load_dotenv()
```
ã“ã¡ã‚‰ã§.envã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§APIã‚­ãƒ¼æƒ…å ±ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦exportã™ã‚‹ã€‚  
.envã¯gitã«ã‚¢ãƒƒãƒ—ã—ã¦ã„ãªã„ã®ã§åˆ©ç”¨è€…ãŒä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```
# OpenAIã®ãƒ¢ãƒ‡ãƒ«ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
llm = ChatOpenAI(
    model_name="gpt-4.1",
    temperature=0,
)
```
ã“ã“ã§ä½¿ç”¨ã™ã‚‹ç”ŸæˆAIã®ç¨®é¡ã‚’å®šç¾©ã™ã‚‹ã€‚ä»Šå›ã¯gpt-4.1ã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚

```
client = MultiServerMCPClient(
    {
        "Weather": {
            "command": "python",
            "args": ["/app/weather_mcp.py"],
            "transport": "stdio",
        },
        "RoomStatusNow": {
            "command": "python",
            "args": ["/app/room_mcp.py"],
            "transport": "stdio",
        },
    }
)
```
ã“ã“ã§å…ˆã»ã©å®šç¾©ã—ãŸWeatherã®MCPãªã©ã‚’ç”ŸæˆAIãŒèªè­˜ã§ãã‚‹ã‚ˆã†ãªã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¦ã„ã‚‹ã€‚  
argsã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ãŒ/appã§å§‹ã¾ã‚‹ã®ã¯ã€Dockerã‚³ãƒ³ãƒ†ãƒŠä¸Šã§appã‚’/ä»¥ä¸‹ã«é…ç½®ã—ã¦ã„ã‚‹ãŸã‚ã€‚

```
async def main():
    response = None
    tools = await client.get_tools()
    agent = create_react_agent(
        llm,
        tools,
    )
```
ã“ã“ã§å‰2ã¤ã§å®šç¾©ã—ã¦ã„ãŸç”ŸæˆAIã¨MCPã®ãƒ„ãƒ¼ãƒ«ç¾¤ã‹ã‚‰AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œæˆã—ã¦ã„ã‚‹ã€‚

```
    messages = [
        SystemMessage(
            content=(
                "ã‚ãªãŸã¯è¦ªã—ã¿ã‚„ã™ã„ã‚¢ãƒŠã‚¦ãƒ³ã‚µãƒ¼ã§ã™ã€‚"
                "éŸ³å£°èª­ã¿ä¸Šã’ã—ã‚„ã™ã„ã‚ˆã†ãª150å­—ç¨‹åº¦ã®æ–‡ç« ã«ã—ã¦ãã ã•ã„ã€‚"
            )
        ),
        HumanMessage(
            content=(
                "æ˜æ—¥ã®å¤©æ°—ã¨ãŠã™ã™ã‚ã®æœè£…ã¯ï¼Ÿ"
            )
        )
    ]

    with get_openai_callback() as cb:
        response = await agent.ainvoke(
            {"messages": messages}
        )

        for msg in response["messages"]:
            msg.pretty_print()

        print(f"ğŸ”¢ ä½¿ç”¨ãƒˆãƒ¼ã‚¯ãƒ³æ•°: {cb.total_tokens}")
        print(f"ğŸ“¥ å…¥åŠ›ãƒˆãƒ¼ã‚¯ãƒ³: {cb.prompt_tokens}")
        print(f"ğŸ“¤ å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³: {cb.completion_tokens}")
        print(f"ğŸ’° æ¨å®šã‚³ã‚¹ãƒˆ: ${cb.total_cost:.6f}")
```
æœ€å¾Œã«agent.ainvokeã§ç”ŸæˆAIã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ¸¡ã—ã¦å‡¦ç†ã‚’å®Ÿè¡Œã•ã›ã¦ã„ã‚‹ã€‚

### ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºæ€§ã«ã¤ã„ã¦

ã“ã®ã‚ˆã†ã«éå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ãªå½¢ã§MCPã‚’å®Ÿè£…ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚  
MCPéƒ¨åˆ†ã«è‡ªåˆ†ãŒæä¾›ã—ãŸã„æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¦ã„ãã€`client = MultiServerMCPClient`ã®éƒ¨åˆ†ã§èª­ã¿è¾¼ã¾ã›ã‚‹ã“ã¨ã§ç°¡å˜ã«æ©Ÿèƒ½è¿½åŠ ã§ãã‚‹ã€‚

ã“ã†è€ƒãˆã‚‹ã¨ã€ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿æ›¸ãã¨ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè¡Œæ¨©é™ã‚’ä¸ãˆã‚Œã°å‹æ‰‹ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’æ›¸ã„ã¦å®Ÿè¡Œã—ã¦ãã‚Œã‚‹ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒä½œã‚Œãã†ã«æ€ãˆã‚‹ã€‚  
ãã†ã—ã¦ä½œã£ãŸã®ãŒdiag-agent-execã«ãªã‚‹ã€‚

### ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã®å¯¾è©±æ©Ÿèƒ½

ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚’ä½œã‚‹ã«ã‚ãŸã£ã¦äººé–“ã¨è¤‡æ•°å›ä¼šè©±ã®ã‚­ãƒ£ãƒƒãƒãƒœãƒ¼ãƒ«ã‚’ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

```
        response = await agent.ainvoke(
            {"messages": messages}
        )
```
ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œã®æˆ»ã‚Šå€¤ã®`response["messages"]`ã«ä»Šã¾ã§ã®ã‚„ã‚Šå–ã‚ŠãŒå…¨ã¦å«ã¾ã‚Œã¦ã„ã‚‹ã€‚

```
    messages = initial_messages
    print("ğŸ” å…¥åŠ›ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ï¼ˆ'exit', 'quit', ç©ºå…¥åŠ›ã§çµ‚äº†ï¼‰")

    while True:
        old_messages = messages.copy()
        user_input = input("user>>> ").strip()
        if user_input in ("exit", "quit", ""):
            print("ğŸ‘‹ çµ‚äº†ã—ã¾ã™")
            break
        try:
            human_message = HumanMessage(content=user_input)
            messages.append(human_message)

            result_response = await agent_invoke(agent, messages)
            messages = result_response["messages"]
        except Exception as e:
            print(f"[âœ—] ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: {e}")
            messages = old_messages
```
ã“ã®ã‚ˆã†ã«ã€ãƒ«ãƒ¼ãƒ—ã§
 - ãƒ¦ãƒ¼ã‚¶ã‹ã‚‰ã®å…¥åŠ›å—ã‘å–ã‚Š
 - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å±¥æ­´ã®æœ«å°¾ã«è¿½åŠ 
 - ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå®Ÿè¡Œ
ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§å¯¾è©±ã‚’ç¶™ç¶šçš„ã«å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚

